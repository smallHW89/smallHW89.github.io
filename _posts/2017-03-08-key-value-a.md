---
date: 2017-03-08 15:44
status: public
title: 谈谈key-value 存储-1
---

# 序言
很多技术文章提到互联网业务的分层架构时，都会提到 
1、接入层
2、逻辑层
3、缓存层，本机缓存，或者远程缓存
4、存储层（数据层）
互联网业务的业务数据、用户数据 最终都落地在存储层里面。根据业务需求，这里数据存储层 有很多技术选型。
##根据业务需求场景确定技术选型
近几年No-Sql这个词很火，好像Sql数据库过时了，业务用用了Sql数据库就很Low，没有用No-Sql技术就不行。其实这里没有哪一种技术、系统，软件是绝对的最好，一切都要根据业务场景，业务需求来确定。
场景1：QQ的用户资料，一般只是读取、修改某一个用户的资料。读量远远大于写量。 多个QQ用户的资料数据之间不存在关系，这里用key-value存储比较适合。
场景2：某视频网站，前端要查询某个演员的所有影片，或者2017年上映的所有有影片。这里用 key-value存储就不一定可以了；可以用sql关系数据库，当然可以中间增加key-value缓存，比如memcache; 或者用elasticsearch这个开源的搜索服务器。
场景3：微信朋友圈中 某个用户发表的状态，应该如何存储？
场景4：QQ空间，微信朋友圈中用户发表的图片，使用什么存储？

## 几个常见的开源key-value存储系统
1、redis： 
key-value, value支持string, set, dict, list,  有序set
2、memcached
key-value , value只是一段buffer
3、leveldb
key-value, value是一段buffer .一个key-value存储引擎，不包含网络处理的功能
4、rocksdb
facebook 基于rocksdb 开发的。

## key-value存储系统设计需要考虑的几个方面
1、机器存储介质的组织管理，通常是内存，磁盘文件等，也可以称为存储引擎。
2、提供的接口, 比如memcached, leveldb接口比较简单，只能set get一个value(buffer), redis的接口比较丰富。
3、集群分布管理，如何sharding, 如何扩缩容， 数据的路由分布
4、数据的容灾，多备份容灾时的数据复制、一致性。
5、数据备份，数据恢复
6、读写性能
7、网络部分，进程线程模型

## 谈谈key-value 存储系统的存储模型，存储管理
一般计算机的存储介质：
1、寄存器
2、L1,L2 cache
3、内存 
4、SSD硬盘
5、机械硬盘 
上面的介质，从上到下，单位存储空间的价格越来越便宜，访问速度和读写性能越来越低。
这里key-value存储系统主要利用计算机的内存、SSD硬盘、机械硬盘。
PS :下面表格显示错乱，直接进github工厂目录下看markdwon文件就好

| 类别        | 每秒读写次数           | 每GB价格/元  |随机读  |随机写  |
| --------- |:---------------------:| ---------------:| ------- | ------- |
| 内存       | 千万级别                  |  150                 |  友好   | 友好    |
| SSD硬盘| 几万级别                  |  20                   |  友好   | 写入放大问题|
|机械硬盘|  几百级别                  |  3                     |不友好| 不友好  |  


一个key-value存储，需要根据key很快找到属于这个key的数据，通常为了快速通过key查找到数据，这里需要对key做索引。另外需要管理索引（key), 数据的存储部分


| 索引结构              |   备注      |
| ------------------ | ---------------- |
| 树形结构，如B+等 | key之间有序 | 实现代码复杂|
| skip_list         |  key之间有序 ，代码实现相对简单，插入，查找的时间复杂度类似折半查找|   |
| hash              |  key之间无序，代码实现简单，插入，查找时间复杂度 O(1) |


|索引(key)存储介质 |  value存储介质   |      备注           |
| ------------------- | ----------------- | --------------- |
| 全部内存中           |  全部内存中         |   读写性能高，成本高，单机容量小                     |
| 全部内存中           |  SSD磁盘（内存中可以部分缓存）| 查找key高性能，读性能高，写数据时要解决写放大问题， 成本低于上一种，受限制于内存容量， 如果key-value大小比例接近时，SSD磁盘容量利用虑不高|
|全部内存中           |  机械硬盘（内存，SSD中部分缓存，或者做冷热数据分层） | 成本低，受限于内存容量限制，如果key-value大小接近时，SSD磁盘利用率不高|
|部分内存中，部分存储在SSD或者机械硬盘| 机械硬盘（内存，SSD中部分缓存，或者做冷热数据分层） | 成本低 ，实现复杂 |

